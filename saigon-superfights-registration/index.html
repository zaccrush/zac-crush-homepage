<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saigon Superfights | Event Hub</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* Using Inter font for a cleaner look */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
    
    body {  
        background-color: #111;  
        color: #eee;  
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;  
        background-image: url('https://github.com/zaccrush/zac-crush-homepage/blob/main/saigon-superfights-grappling-ram-muay-thai.jpeg?raw=true');
        background-size: cover;
        background-position: center center;
        background-attachment: fixed;
    }
    .body-overlay {
        background-color: rgba(0, 0, 0, 0.85);
        min-height: 100vh;
    }
    .card {  
        background-color: rgba(30, 30, 30, 0.9);  
        border: 1px solid #444;  
        transition: all 0.3s ease-in-out;  
        backdrop-filter: blur(4px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 5px 10px rgba(0, 0, 0, 0.2);
    }
    .admin-badge { background-color: #d4af37; color: black; }
    .status-badge { padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
    .status-approved { background-color: #22c55e; color: white; }
    .status-pending { background-color: #eab308; color: black; }
    .status-rejected { background-color: #ef4444; color: white; }
    .input-field { background-color: #333; border-color: #555; transition: all 0.2s ease-in-out; }
    .input-field:focus { box-shadow: 0 0 0 2px #d4af37; border-color: #d4af37; ring: 0; outline: 0; }
    .view-container { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
    
    /* Custom Modal Styles for better UX than alert/confirm */
    .modal-backdrop {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }
    .modal-backdrop.visible {
        opacity: 1;
        pointer-events: auto;
    }
    .modal-content {
        background-color: #2d2d2d;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid #555;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        transform: scale(0.95);
        transition: transform 0.3s ease;
        max-width: 90%;
        width: 400px;
    }
    .modal-backdrop.visible .modal-content {
        transform: scale(1);
    }
  </style>
</head>
<body>
<div class="body-overlay p-4 sm:p-6">
  <div class="max-w-2xl mx-auto">
    <!-- Header Section -->
    <header class="text-center mb-6">
        <img src="https://raw.githubusercontent.com/zaccrush/zac-crush-homepage/4f38e25754d34b0e66645603976bb5e4d4e24916/saigon%20superfights%20logo.jpg" alt="Logo" class="w-72 sm:w-96 mx-auto mb-2 rounded-lg transition-transform duration-300 hover:scale-105">
        <h1 id="page-title" class="text-2xl sm:text-3xl font-bold text-yellow-400 uppercase tracking-wider">Fight Card</h1>
        <p id="user-status" class="text-gray-400 text-sm h-5 mt-1"></p>
    </header>

    <!-- Main Content Area -->
    <main>
        <!-- View Toggler & Login -->
        <div class="flex justify-between items-center mb-6">
            <button id="view-toggle-btn" class="px-4 py-2 text-sm bg-gray-700 rounded-md hover:bg-gray-600 transition-colors">Register to Compete</button>
            <div id="auth-section">
                <form id="admin-login-form" class="flex items-center gap-2">
                    <input type="email" id="admin-email" placeholder="Admin Email" class="input-field rounded-md p-2 text-sm w-48">
                    <button type="submit" class="px-4 py-2 text-sm bg-blue-600 rounded-md hover:bg-blue-500 transition-colors">Sign In</button>
                </form>
                <button id="logout-btn" class="hidden px-4 py-2 text-sm bg-red-600 rounded-md">Sign Out</button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view-container">
            <div id="dashboard-container" class="space-y-4">
                <p id="loading-indicator" class="text-center text-gray-400">Loading fighters...</p>
            </div>
        </div>

        <!-- Registration View (hidden by default) -->
        <div id="registration-view" class="view-container hidden opacity-0 scale-95">
            <form id="ssf-form" class="space-y-6" autocomplete="off">
                <div class="card p-4 sm:p-6 rounded-lg space-y-4">
                    <!-- Personal Info -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-300">Full Name</label>
                        <input type="text" id="name" required class="input-field mt-1 block w-full rounded-md p-3 text-white">
                    </div>
                    <div>
                        <label for="birthYear" class="block text-sm font-medium text-gray-300">Birth Year</label>
                        <input type="number" id="birthYear" required placeholder="e.g., 1995" class="input-field mt-1 block w-full rounded-md p-3 text-white">
                    </div>
                    <div>
                        <label for="team" class="block text-sm font-medium text-gray-300">Team</label>
                        <input type="text" id="team" class="input-field mt-1 block w-full rounded-md p-3 text-white">
                    </div>
                    <div>
                        <label for="weight" class="block text-sm font-medium text-gray-300">Weight (kg)</label>
                        <input type="number" step="0.1" id="weight" required class="input-field mt-1 block w-full rounded-md p-3 text-white">
                    </div>
                     <div>
                        <label for="belt" class="block text-sm font-medium text-gray-300">BJJ Belt Level</label>
                        <select id="belt" required class="input-field mt-1 block w-full rounded-md p-3 text-white">
                            <option value="">Select Belt...</option>
                            <option value="White">White</option><option value="Blue">Blue</option><option value="Purple">Purple</option><option value="Brown">Brown</option><option value="Black">Black</option>
                        </select>
                    </div>
                    <!-- Fight Preferences -->
                     <div>
                        <label for="fightStatus" class="block text-sm font-medium text-gray-300">Status</label>
                        <select id="fightStatus" required class="input-field mt-1 block w-full rounded-md p-3 text-white">
                            <option value="Ready to Fight!">Ready to Fight!</option>
                            <option value="Not Looking for Superfight">Not Looking for Superfight</option>
                        </select>
                    </div>
                     <div>
                        <label for="idealOpponent" class="block text-sm font-medium text-gray-300">Ideal Opponent (Optional)</label>
                        <input type="text" id="idealOpponent" placeholder="Name, weight, belt, style..." class="input-field mt-1 block w-full rounded-md p-3 text-white">
                    </div>
                    <div>
                        <label for="opportunity" class="block text-sm font-medium text-gray-300">What's one opportunity you've always wanted in martial arts?</label>
                        <textarea id="opportunity" rows="3" required class="input-field mt-1 block w-full rounded-md p-3 text-white"></textarea>
                    </div>
                    <div>
                        <label for="excitement" class="block text-sm font-medium text-gray-300">How could we make this app more exciting?</label>
                        <textarea id="excitement" rows="3" required class="input-field mt-1 block w-full rounded-md p-3 text-white"></textarea>
                    </div>
                </div>
                <div>
                    <button id="submit-btn" type="submit" class="w-full px-6 py-4 text-lg font-bold text-white bg-red-600 rounded-lg shadow-lg hover:bg-red-700 transition-all duration-300">
                        Submit Registration
                    </button>
                </div>
                <div id="form-message" class="text-center text-sm h-4"></div>
            </form>
        </div>
    </main>
  </div>
</div>

<!-- Custom Modal for Confirmations and Alerts -->
<div id="custom-modal" class="modal-backdrop">
    <div class="modal-content">
        <p id="modal-message" class="text-white mb-4">Modal message goes here.</p>
        <div id="modal-actions" class="flex justify-end gap-3">
            <button id="modal-cancel-btn" class="px-4 py-2 text-sm bg-gray-600 rounded-md hover:bg-gray-500 transition-colors">Cancel</button>
            <button id="modal-confirm-btn" class="px-4 py-2 text-sm bg-red-600 rounded-md hover:bg-red-500 transition-colors">Confirm</button>
        </div>
    </div>
</div>

<script>
    // =================================================================
    // ============== CONFIGURATION - PASTE YOUR IDs HERE ==============
    // =================================================================
    // IMPORTANT: You MUST replace these placeholder values with your actual credentials.
    // 1. Get your script URL after deploying your Google Apps Script.
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxGHTY24TPRYt7tXI-YkqKJn9ro1hxS1WJU11Zqe_fl1GRZC5hVoCPYlGaNlIXWgYlXww/exec";
    // 2. List the email addresses that should have admin privileges.
    const ADMIN_EMAILS = ['admin1@example.com', 'admin2@example.com', 'z@z.com'];
    // =================================================================

    // --- App State ---
    let isAdmin = false;
    let currentView = 'dashboard'; // 'dashboard' or 'registration'

    // --- DOM Elements ---
    const pageTitle = document.getElementById('page-title');
    const dashboardView = document.getElementById('dashboard-view');
    const registrationView = document.getElementById('registration-view');
    const viewToggleBtn = document.getElementById('view-toggle-btn');
    const adminLoginForm = document.getElementById('admin-login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const userStatusEl = document.getElementById('user-status');
    const ssfForm = document.getElementById('ssf-form');
    const modal = document.getElementById('custom-modal');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    // --- Initialization ---
    window.onload = function () {
      updateUI();
      loadFighters();
    };

    // --- Authentication ---
    adminLoginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const emailInput = document.getElementById('admin-email');
        const email = emailInput.value.trim().toLowerCase();
        if (ADMIN_EMAILS.includes(email)) {
            isAdmin = true;
            updateUI();
            loadFighters();
            emailInput.value = '';
        } else {
            showModal("Invalid admin email.");
            isAdmin = false;
        }
    });
    
    logoutBtn.addEventListener('click', () => {
        isAdmin = false;
        updateUI();
        loadFighters();
    });

    // --- UI Management ---
    function updateUI() {
        // Auth section
        if (isAdmin) {
            adminLoginForm.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            userStatusEl.innerHTML = `Welcome, Admin <span class="admin-badge font-bold px-2 py-1 rounded-md text-xs">ADMIN</span>`;
        } else {
            adminLoginForm.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            userStatusEl.textContent = 'Sign in as Admin to manage fighters.';
        }
        
        // View toggling with smooth transitions
        if (currentView === 'dashboard') {
            registrationView.classList.add('opacity-0', 'scale-95');
            dashboardView.classList.remove('hidden');
            setTimeout(() => {
                dashboardView.classList.remove('opacity-0', 'scale-95');
                registrationView.classList.add('hidden');
            }, 50); // A small delay ensures the transition is smooth
            viewToggleBtn.textContent = 'Register to Compete';
            pageTitle.textContent = 'Fight Card';
        } else {
            dashboardView.classList.add('opacity-0', 'scale-95');
            registrationView.classList.remove('hidden');
            setTimeout(() => {
                registrationView.classList.remove('opacity-0', 'scale-95');
                dashboardView.classList.add('hidden');
            }, 50);
            viewToggleBtn.textContent = 'View Fight Card';
            pageTitle.textContent = 'Grappler Registration';
        }
    }
    
    viewToggleBtn.addEventListener('click', () => {
        currentView = (currentView === 'dashboard') ? 'registration' : 'dashboard';
        updateUI();
    });

    // --- Data Fetching & Rendering ---
    async function loadFighters() {
        const container = document.getElementById('dashboard-container');
        container.innerHTML = `<p class="text-center text-gray-400">Loading fighters...</p>`;
        
        try {
            let fighters = [];
            // FIX: If the script URL is a placeholder, use mock data instead of throwing an error.
            // This allows the UI to be tested without a live backend.
            if (SCRIPT_URL.includes("YOUR_DEPLOYED_GOOGLE_APPS_SCRIPT_URL")) {
                console.warn("Using mock data because SCRIPT_URL is not configured.");
                fighters = [
                    { name: "John 'The Mauler' Doe", team: "Tiger Muay Thai", weight: "77", belt: "Brown", fightStatus: "Ready to Fight!", status: "Approved" },
                    { name: "Jane 'The Jaguar' Smith", team: "Saigon Sports Club", weight: "65", belt: "Purple", fightStatus: "Ready to Fight!", status: "Approved" },
                    { name: "Mike 'The Python' Williams", team: "Kimura BJJ", weight: "84", belt: "Black", fightStatus: "Not Looking for Superfight", status: "Pending" },
                    { name: "Sarah 'The Viper' Jones", team: "Renzo Gracie Saigon", weight: "60", belt: "Blue", fightStatus: "Ready to Fight!", status: "Rejected" },
                ];
            } else {
                // If a real URL is provided, fetch the data.
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error(`Network response was not ok`);
                fighters = await response.json(); 
            }

            const fightersToDisplay = isAdmin ? fighters : fighters.filter(f => f.status && f.status.toLowerCase() === 'approved');
            
            if (fightersToDisplay.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-400">No fighters to display. Register or check back soon!</p>`;
                return;
            }
            container.innerHTML = fightersToDisplay.map(renderFighterCard).join('');
            
        } catch (error) {
            handleError(error, 'Failed to load fighters');
        }
    }
    
    function renderFighterCard(fighter) {
        const adminControls = isAdmin ? `
            <div class="admin-actions mt-3 pt-3 border-t border-gray-600 flex justify-end gap-2">
                <button onclick="confirmStatusUpdate('${fighter.name}', 'approved')" class="px-3 py-1 text-xs bg-green-600 rounded-md hover:bg-green-500 transition-colors">Approve</button>
                <button onclick="confirmStatusUpdate('${fighter.name}', 'rejected')" class="px-3 py-1 text-xs bg-red-700 rounded-md hover:bg-red-600 transition-colors">Reject</button>
            </div>
        ` : '';
        
        const fightStatusColor = fighter.fightStatus === 'Ready to Fight!' ? 'text-green-400' : 'text-yellow-500';

        return `
            <div class="card rounded-lg p-4">
                <div class="flex flex-col sm:flex-row justify-between items-center text-center sm:text-left">
                    <div class="mb-2 sm:mb-0">
                        <p class="text-xl font-bold text-white">${escapeHtml(fighter.name)}</p>
                        <p class="text-sm text-gray-400">${escapeHtml(fighter.team)} • ${escapeHtml(fighter.weight)}kg • ${escapeHtml(fighter.belt)} Belt</p>
                        <p class="text-xs mt-1 ${fightStatusColor}">${escapeHtml(fighter.fightStatus)}</p>
                    </div>
                    <div class="text-right">
                        <span class="status-badge status-${fighter.status ? fighter.status.toLowerCase() : 'pending'}">${escapeHtml(fighter.status)}</span>
                    </div>
                </div>
                ${adminControls}
            </div>
        `;
    }
    
    // --- Form & Admin Actions ---
    ssfForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-btn');
        const formMessage = document.getElementById('form-message');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        formMessage.textContent = '';

        const payload = {
            name: ssfForm.name.value.trim(),
            birthYear: ssfForm.birthYear.value,
            team: ssfForm.team.value.trim(),
            weight: parseFloat(ssfForm.weight.value) || null,
            belt: ssfForm.belt.value,
            fightStatus: ssfForm.fightStatus.value,
            idealOpponent: ssfForm.idealOpponent.value.trim(),
            opportunity: ssfForm.opportunity.value.trim(),
            excitement: ssfForm.excitement.value.trim(),
        };
        
        try {
            if (SCRIPT_URL.includes("YOUR_DEPLOYED_GOOGLE_APPS_SCRIPT_URL")) {
                 // Simulate a successful submission for testing purposes
                console.log("Mock submission:", payload);
                showModal("This is a mock submission. Data was not saved.");
            } else {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'register', payload: payload }),
                });
                const result = await response.json();
                if (result.result !== 'success') throw new Error(result.message);
            }
            
            formMessage.textContent = 'Thank you! Your registration has been submitted.';
            formMessage.style.color = '#34d399';
            ssfForm.reset();
            setTimeout(() => { 
                currentView = 'dashboard'; 
                updateUI(); 
                loadFighters(); 
            }, 2000);
        } catch (error) {
            handleError(error, 'Could not submit registration', formMessage);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Registration';
        }
    });

    function confirmStatusUpdate(fighterName, newStatus) {
        if (!isAdmin) {
             showModal("Permission Denied.");
             return;
        }
        showModal(`Set status for ${fighterName} to "${newStatus}"?`, () => {
            updateStatus(fighterName, newStatus);
        });
    }

    async function updateStatus(fighterName, newStatus) {
        try {
             if (SCRIPT_URL.includes("YOUR_DEPLOYED_GOOGLE_APPS_SCRIPT_URL")) {
                console.log(`Mock status update for ${fighterName} to ${newStatus}`);
                showModal(`Mock update successful for ${fighterName}.`);
                // In a real app, you'd want to update the mock data array and re-render
                return;
            }
            const response = await fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'updateStatus', payload: { name: fighterName, newStatus: newStatus } }),
            });
            const result = await response.json();
            if (result.result !== 'success') throw new Error(result.message);
            
            loadFighters();
        } catch (error) {
            handleError(error, 'Could not update status');
        }
    }

    // --- Custom Modal Logic ---
    let confirmCallback = null;
    function showModal(message, onConfirm = null) {
        modalMessage.textContent = message;
        confirmCallback = onConfirm;

        if (onConfirm) {
            modalConfirmBtn.classList.remove('hidden');
            modalCancelBtn.textContent = 'Cancel';
        } else {
            modalConfirmBtn.classList.add('hidden');
            modalCancelBtn.textContent = 'Close';
        }
        modal.classList.add('visible');
    }

    function hideModal() {
        modal.classList.remove('visible');
        confirmCallback = null;
    }

    modalConfirmBtn.addEventListener('click', () => {
        if (confirmCallback) {
            confirmCallback();
        }
        hideModal();
    });
    modalCancelBtn.addEventListener('click', hideModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideModal();
        }
    });


    // --- Utilities ---
    function handleError(error, message, element = document.getElementById('dashboard-container')) {
        console.error(message + ':', error);
        const displayMessage = `${message}. ${error.message}`;
        if (element.id === 'dashboard-container') {
            element.innerHTML = `<p class="text-center text-red-500">${displayMessage}</p>`;
        } else {
            element.textContent = displayMessage;
            element.style.color = '#ef4444';
        }
    }

    function escapeHtml(unsafe) {
        if (!unsafe) return "";
        return String(unsafe)
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

</script>
</body>
</html>
