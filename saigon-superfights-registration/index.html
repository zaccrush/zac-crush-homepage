<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saigon Superfights | Event Hub</title>
  
  <!-- Google Sign-In Library -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body { 
        background-color: #111; 
        color: #eee; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        background-image: url('https://github.com/zaccrush/zac-crush-homepage/blob/main/saigon-superfights-grappling-ram-muay-thai.jpeg?raw=true');
        background-size: cover;
        background-position: center center;
        background-attachment: fixed;
    }
    .body-overlay {
        background-color: rgba(0, 0, 0, 0.85);
        min-height: 100vh;
    }
    .card { 
        background-color: rgba(30, 30, 30, 0.9); 
        border: 1px solid #444; 
        transition: all 0.3s ease-in-out; 
        backdrop-filter: blur(4px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 5px 10px rgba(0, 0, 0, 0.2);
    }
    .vs-circle { width: 40px; height: 40px; background-color: #dc2626; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; border: 2px solid white; box-shadow: 0 0 10px rgba(220, 38, 38, 0.7); }
    .admin-badge { background-color: #d4af37; color: black; }
    .status-badge { padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
    .status-approved { background-color: #22c55e; color: white; }
    .status-pending { background-color: #eab308; color: black; }
    .status-rejected { background-color: #ef4444; color: white; }
    .input-field { background-color: #333; border-color: #555; transition: all 0.2s ease-in-out; }
    .input-field:focus { box-shadow: 0 0 0 2px #d4af37; border-color: #d4af37; }
    .view-container { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
  </style>
</head>
<body>
<div class="body-overlay p-4 sm:p-6">
  <div class="max-w-2xl mx-auto">
    <!-- Header Section -->
    <header class="text-center mb-6">
        <img src="https://raw.githubusercontent.com/zaccrush/zac-crush-homepage/4f38e25754d34b0e66645603976bb5e4d4e24916/saigon%20superfights%20logo.jpg" alt="Logo" class="w-72 sm:w-96 mx-auto mb-2 rounded-lg transition-transform duration-300 hover:scale-105">
        <h1 id="page-title" class="text-2xl sm:text-3xl font-bold text-yellow-400 uppercase">Fight Card</h1>
        <p id="user-status" class="text-gray-400 text-sm h-5 mt-1"></p>
    </header>

    <!-- Main Content Area -->
    <main>
        <!-- View Toggler & Login -->
        <div class="flex justify-between items-center mb-6">
            <button id="view-toggle-btn" class="px-4 py-2 text-sm bg-gray-700 rounded-md hover:bg-gray-600 transition-colors">Register to Compete</button>
            <div id="auth-container">
                <div id="g_id_onload" data-auto_prompt="false"></div>
                <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="outline" data-text="signin_with" data-size="large" data-logo_alignment="left"></div>
                <button id="logout-btn" class="hidden px-4 py-2 text-sm bg-red-600 rounded-md" onclick="signOut();">Sign Out</button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view-container">
            <div id="dashboard-container" class="space-y-4">
                <p id="loading-indicator" class="text-center text-gray-400">Loading fighters...</p>
            </div>
        </div>

        <!-- Registration View (hidden by default) -->
        <div id="registration-view" class="view-container hidden">
            <form id="ssf-form" class="space-y-6" autocomplete="off">
                <div class="card p-4 sm:p-6 rounded-lg space-y-4">
                    <!-- Personal Info -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-300">Full Name</label>
                        <input type="text" id="name" required class="input-field mt-1 block w-full rounded-md p-3 text-white">
                    </div>
                    <div>
                        <label for="birthYear" class="block text-sm font-medium text-gray-300">Birth Year</label>
                        <input type="number" id="birthYear" required placeholder="e.g., 1995" class="input-field mt-1 block w-full rounded-md p-3 text-white">
                    </div>
                    <div>
                        <label for="team" class="block text-sm font-medium text-gray-300">Team</label>
                        <input type="text" id="team" class="input-field mt-1 block w-full rounded-md p-3 text-white">
                    </div>
                    <div>
                        <label for="weight" class="block text-sm font-medium text-gray-300">Weight (kg)</label>
                        <input type="number" step="0.1" id="weight" required class="input-field mt-1 block w-full rounded-md p-3 text-white">
                    </div>
                     <div>
                        <label for="belt" class="block text-sm font-medium text-gray-300">BJJ Belt Level</label>
                        <select id="belt" required class="input-field mt-1 block w-full rounded-md p-3 text-white">
                            <option value="">Select Belt...</option>
                            <option value="White">White</option><option value="Blue">Blue</option><option value="Purple">Purple</option><option value="Brown">Brown</option><option value="Black">Black</option>
                        </select>
                    </div>
                    <!-- Fight Preferences -->
                     <div>
                        <label for="fightStatus" class="block text-sm font-medium text-gray-300">Status</label>
                        <select id="fightStatus" required class="input-field mt-1 block w-full rounded-md p-3 text-white">
                            <option value="Ready to Fight!">Ready to Fight!</option>
                            <option value="Not Looking for Superfight">Not Looking for Superfight</option>
                        </select>
                    </div>
                     <div>
                        <label for="idealOpponent" class="block text-sm font-medium text-gray-300">Ideal Opponent (Optional)</label>
                        <input type="text" id="idealOpponent" placeholder="Name, weight, belt, style..." class="input-field mt-1 block w-full rounded-md p-3 text-white">
                    </div>
                    <div>
                        <label for="opportunity" class="block text-sm font-medium text-gray-300">What's one opportunity you've always wanted in martial arts?</label>
                        <textarea id="opportunity" rows="3" required class="input-field mt-1 block w-full rounded-md p-3 text-white"></textarea>
                    </div>
                    <!-- NEW QUESTION -->
                    <div>
                        <label for="excitement" class="block text-sm font-medium text-gray-300">How could we make this app more exciting?</label>
                        <textarea id="excitement" rows="3" required class="input-field mt-1 block w-full rounded-md p-3 text-white"></textarea>
                    </div>
                </div>
                <div>
                    <button id="submit-btn" type="submit" class="w-full px-6 py-4 text-lg font-bold text-white bg-red-600 rounded-lg shadow-lg hover:bg-red-700 transition-all duration-300">
                        Submit Registration
                    </button>
                </div>
                <div id="form-message" class="text-center text-sm h-4"></div>
            </form>
        </div>
    </main>
  </div>
</div>
<script>
    // =================================================================
    // ============== CONFIGURATION - PASTE YOUR IDs HERE ==============
    // =================================================================
    const GOOGLE_CLIENT_ID = "YOUR_GOOGLE_API_CLIENT_ID.apps.googleusercontent.com";
    const SCRIPT_URL = "YOUR_DEPLOYED_GOOGLE_APPS_SCRIPT_URL";
    const ADMIN_EMAILS = ['admin1@example.com', 'admin2@example.com'];
    // =================================================================

    // --- App State ---
    let userProfile = null;
    let isAdmin = false;
    let currentView = 'dashboard'; // 'dashboard' or 'registration'

    // --- DOM Elements ---
    const pageTitle = document.getElementById('page-title');
    const dashboardView = document.getElementById('dashboard-view');
    const registrationView = document.getElementById('registration-view');
    const viewToggleBtn = document.getElementById('view-toggle-btn');
    const authContainer = document.getElementById('auth-container');
    const logoutBtn = document.getElementById('logout-btn');
    const userStatusEl = document.getElementById('user-status');
    const ssfForm = document.getElementById('ssf-form');

    // --- Authentication ---
    window.onload = function () {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse
      });
      updateUI();
      loadFighters();
    };

    function handleCredentialResponse(response) {
      const profile = jwt_decode(response.credential);
      userProfile = { name: profile.name, email: profile.email };
      isAdmin = ADMIN_EMAILS.includes(userProfile.email);
      updateUI();
      loadFighters();
    }
    
    function signOut() {
        google.accounts.id.disableAutoSelect();
        userProfile = null;
        isAdmin = false;
        updateUI();
        loadFighters();
    }

    // --- UI Management ---
    function updateUI() {
        // Auth buttons
        if (userProfile) {
            authContainer.querySelector('.g_id_signin').style.display = 'none';
            logoutBtn.classList.remove('hidden');
            let adminText = isAdmin ? ' <span class="admin-badge font-bold px-2 py-1 rounded-md text-xs">ADMIN</span>' : '';
            userStatusEl.innerHTML = `Welcome, ${userProfile.name}${adminText}`;
        } else {
            authContainer.querySelector('.g_id_signin').style.display = 'block';
            logoutBtn.classList.add('hidden');
            userStatusEl.textContent = 'Sign in as Admin to manage fighters.';
        }
        
        // View toggling with smooth transitions
        if (currentView === 'dashboard') {
            registrationView.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                dashboardView.classList.remove('hidden', 'opacity-0', 'scale-95');
                registrationView.classList.add('hidden');
            }, 300);
            viewToggleBtn.textContent = 'Register to Compete';
            pageTitle.textContent = 'Fight Card';
        } else {
            dashboardView.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                registrationView.classList.remove('hidden', 'opacity-0', 'scale-95');
                dashboardView.classList.add('hidden');
            }, 300);
            viewToggleBtn.textContent = 'View Fight Card';
            pageTitle.textContent = 'Grappler Registration';
        }
    }
    
    viewToggleBtn.addEventListener('click', () => {
        currentView = (currentView === 'dashboard') ? 'registration' : 'dashboard';
        updateUI();
    });

    // --- Data Fetching & Rendering ---
    async function loadFighters() {
        const container = document.getElementById('dashboard-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.style.display = 'block';
        container.innerHTML = `<p id="loading-indicator" class="text-center text-gray-400">Loading fighters...</p>`;
        
        try {
            const response = await fetch(SCRIPT_URL);
            if (!response.ok) throw new Error(`Network response was not ok`);
            const fighters = await response.json(); 

            loadingIndicator.style.display = 'none';
            const fightersToDisplay = isAdmin ? fighters : fighters.filter(f => f.status && f.status.toLowerCase() === 'approved');
            
            if (fightersToDisplay.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-400">No fighters to display. Register or check back soon!</p>`;
                return;
            }
            container.innerHTML = fightersToDisplay.map(renderFighterCard).join('');
            
        } catch (error) {
            handleError(error, 'Failed to load fighters');
        }
    }
    
    function renderFighterCard(fighter) {
        const adminControls = isAdmin ? `
            <div class="admin-actions mt-3 pt-3 border-t border-gray-600 flex justify-end gap-2">
                <button onclick="updateStatus('${fighter.name}', 'approved')" class="px-3 py-1 text-xs bg-green-600 rounded-md hover:bg-green-500 transition-colors">Approve</button>
                <button onclick="updateStatus('${fighter.name}', 'rejected')" class="px-3 py-1 text-xs bg-red-700 rounded-md hover:bg-red-600 transition-colors">Reject</button>
            </div>
        ` : '';
        
        const fightStatusColor = fighter.fightStatus === 'Ready to Fight!' ? 'text-green-400' : 'text-yellow-500';

        return `
            <div class="card rounded-lg p-4">
                <div class="flex flex-col sm:flex-row justify-between items-center text-center sm:text-left">
                    <div class="mb-2 sm:mb-0">
                        <p class="text-xl font-bold text-white">${escapeHtml(fighter.name)}</p>
                        <p class="text-sm text-gray-400">${escapeHtml(fighter.team)} • ${escapeHtml(fighter.weight)}kg • ${escapeHtml(fighter.belt)} Belt</p>
                        <p class="text-xs mt-1 ${fightStatusColor}">${escapeHtml(fighter.fightStatus)}</p>
                    </div>
                    <div class="text-right">
                        <span class="status-badge status-${fighter.status ? fighter.status.toLowerCase() : 'pending'}">${escapeHtml(fighter.status)}</span>
                    </div>
                </div>
                ${adminControls}
            </div>
        `;
    }
    
    // --- Form & Admin Actions ---
    ssfForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-btn');
        const formMessage = document.getElementById('form-message');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        formMessage.textContent = '';

        const payload = {
            name: ssfForm.name.value.trim(),
            birthYear: ssfForm.birthYear.value,
            team: ssfForm.team.value.trim(),
            weight: parseFloat(ssfForm.weight.value) || null,
            belt: ssfForm.belt.value,
            fightStatus: ssfForm.fightStatus.value,
            idealOpponent: ssfForm.idealOpponent.value.trim(),
            opportunity: ssfForm.opportunity.value.trim(),
            excitement: ssfForm.excitement.value.trim(), // New field
            experience: "" // Deprecated but kept for schema consistency if needed
        };
        
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'register', payload: payload }),
            });
            const result = await response.json();
            if (result.result !== 'success') throw new Error(result.message);
            
            formMessage.textContent = 'Thank you! Your registration has been submitted.';
            formMessage.style.color = '#34d399';
            ssfForm.reset();
            setTimeout(() => { 
                currentView = 'dashboard'; 
                updateUI(); 
                loadFighters(); 
            }, 2000);
        } catch (error) {
            handleError(error, 'Could not submit registration', formMessage);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Registration';
        }
    });

    async function updateStatus(fighterName, newStatus) {
        if (!isAdmin) return alert('Permission denied.');
        if (!confirm(`Set status for ${fighterName} to "${newStatus}"?`)) return;
        
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'updateStatus', payload: { name: fighterName, newStatus: newStatus } }),
            });
            const result = await response.json();
            if (result.result !== 'success') throw new Error(result.message);
            
            loadFighters();
        } catch (error) {
            handleError(error, 'Could not update status');
        }
    }

    // --- Utilities ---
    function jwt_decode(t){const e=t.split(".")[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(decodeURIComponent(atob(e).split("").map(t=>"%" + ("00" + t.charCodeAt(0).toString(16)).slice(-2)).join("")))}
    function handleError(error, message, element = document.getElementById('dashboard-container')) {
        console.error(message + ':', error);
        if (element.id === 'dashboard-container') {
            element.innerHTML = `<p class="text-center text-red-500">${message}. Please try again.</p>`;
        } else {
            element.textContent = `${message}. Please try again.`;
            element.style.color = '#ef4444';
        }
    }
    function escapeHtml(unsafe){return unsafe?String(unsafe).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}

</script>
</body>
</html>
