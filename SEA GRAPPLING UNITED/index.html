import React, { useEffect, useState, useCallback } from "react";
import { initializeApp } from "firebase/app";
import {
  getAuth,
  onAuthStateChanged,
  signOut,
  signInAnonymously,
  signInWithCustomToken,
} from "firebase/auth";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  collection,
  onSnapshot,
  query,
  updateDoc,
  deleteDoc,
  serverTimestamp,
} from "firebase/firestore";

// --- Gemini API Helper ---
const callGeminiAPI = async (payload, maxRetries = 3) => {
    const apiKey = ""; // Provided by the environment
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
    
    let attempt = 0;
    while (attempt < maxRetries) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);

            const result = await response.json();
            
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                return result.candidates[0].content.parts[0].text;
            } else {
                if (result.promptFeedback) {
                    console.warn("Prompt feedback:", result.promptFeedback);
                    throw new Error("Content generation blocked. Please adjust the prompt.");
                }
                throw new Error("Invalid response structure from Gemini API.");
            }
        } catch (error) {
            console.error(`Attempt ${attempt + 1} failed:`, error.message);
            attempt++;
            if (attempt >= maxRetries) throw error;
            const delay = Math.pow(2, attempt) * 1000;
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
};

// --- Constants & Config ---
const BELTS = ["White", "Blue", "Purple", "Brown", "Black"];
const CONTACT_METHODS = ["Email", "WhatsApp", "Telegram", "Facebook", "Instagram"];
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const getGrapplersCollection = () => collection(db, `artifacts/${appId}/public/data/grapplers`);
const getGrapplerDoc = (uid) => doc(db, `artifacts/${appId}/public/data/grapplers`, uid);

// --- Main App Component ---
export default function SEAGrapplingUnitedApp() {
  const [user, setUser] = useState(null);
  const [userId, setUserId] = useState(null);
  const [loadingUser, setLoadingUser] = useState(true);
  const [page, setPage] = useState('home');
  
  const [modal, setModal] = useState({ isOpen: false, title: '', content: '', onConfirm: null });
  const [notification, setNotification] = useState({ isVisible: false, message: '', type: 'success' });

  const showNotification = useCallback((message, type = 'success') => {
    setNotification({ isVisible: true, message, type });
    setTimeout(() => setNotification({ isVisible: false, message: '', type: 'success' }), 3000);
  }, []);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      if (currentUser) {
        setUser(currentUser);
        setUserId(currentUser.uid);
      } else {
        try {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("Authentication failed:", error);
          showNotification("Authentication failed. Please refresh.", "error");
        }
      }
      setLoadingUser(false);
    });
    return () => unsubscribe();
  }, [showNotification]);

  const navigateTo = (targetPage) => setPage(targetPage);

  const showModal = (title, content, onConfirm) => setModal({ isOpen: true, title, content, onConfirm });
  const handleModalClose = () => setModal({ isOpen: false, title: '', content: '', onConfirm: null });
  const handleModalConfirm = () => {
    if (modal.onConfirm) modal.onConfirm();
    handleModalClose();
  };

  if (loadingUser) {
    return <div className="min-h-screen bg-gray-100 flex items-center justify-center"><div className="text-gray-600">Loading Community Platform...</div></div>;
  }

  return (
    <div className="flex flex-col min-h-screen bg-gradient-to-b from-slate-100 to-gray-200 p-4 sm:p-6 font-sans">
      <div className="max-w-7xl mx-auto w-full">
        <Header user={user} page={page} navigateTo={navigateTo} />
        <main className="mt-6 flex-grow">
          {page === 'home' && user && userId && (
              <HomePage currentUser={user} currentUserId={userId} showNotification={showNotification} showModal={showModal} />
          )}
          {page === 'faq' && (
              <FAQPage />
          )}
        </main>
        <Footer />
      </div>
      <Modal isOpen={modal.isOpen} title={modal.title} onClose={handleModalClose} onConfirm={handleModalConfirm}>{modal.content}</Modal>
      <Notification isVisible={notification.isVisible} message={notification.message} type={notification.type} />
    </div>
  );
}

function HomePage({currentUser, currentUserId, showNotification, showModal}) {
    return (
        <>
            <Hero />
            <div className="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-1 space-y-6">
                <ProfileCard userId={currentUserId} />
                <RegisterCard userId={currentUserId} showNotification={showNotification} showModal={showModal} />
              </div>
              <div className="lg:col-span-2">
                <Dashboard currentUser={currentUser} showNotification={showNotification} />
              </div>
            </div>
        </>
    );
}

// --- UI Components ---
function Header({ user, page, navigateTo }) {
  if (page === 'faq') {
    return (
      <header className="bg-gray-800 py-4 rounded-lg">
        <nav className="flex justify-center items-center gap-8">
          <button onClick={() => navigateTo('home')} className="text-white text-sm font-medium hover:text-yellow-400 transition-colors">HOME</button>
          <a href="#" className="text-white text-sm font-medium hover:text-yellow-400 transition-colors">Youtube</a>
          <a href="#" className="text-white text-sm font-medium hover:text-yellow-400 transition-colors">GMA Fighter Registration</a>
          <a href="#" className="text-white text-sm font-medium hover:text-yellow-400 transition-colors">Saigon Superfights Registration</a>
        </nav>
      </header>
    );
  }

  return (
    <header className="flex items-center justify-between">
      <div>
        <h1 className="text-2xl md:text-3xl font-black text-black">SEA Grappling United</h1>
        <p className="text-sm text-slate-700 font-medium">Pooling Resources, Ideas, and Passion</p>
      </div>
      <div className="flex items-center gap-4">
        <button onClick={() => navigateTo('faq')} className="px-4 py-2 rounded-lg bg-slate-200 text-slate-800 hover:bg-slate-300 transition-colors text-sm font-semibold">FAQ</button>
        {user && <button onClick={() => signOut(auth)} className="px-4 py-2 rounded-lg bg-slate-200 text-slate-800 hover:bg-slate-300 transition-colors text-sm font-semibold">Sign out</button>}
      </div>
    </header>
  );
}

function Hero() {
  return (
    <div className="rounded-xl p-6 bg-white shadow-lg border-t-4 border-yellow-400">
      <div className="flex items-center gap-4">
        <div className="flex-1">
          <h2 className="text-xl font-bold text-slate-900">A United Front for Southeast Asian Grappling</h2>
          <p className="text-slate-800 mt-1">The first platform of its kind that aims to build upon all community efforts and resources from the region in an effort to provide more opportunities for all.</p>
        </div>
        <div className="text-4xl text-slate-500">ü§ù</div>
      </div>
    </div>
  );
}

function ProfileCard({ userId }) {
  const [profile, setProfile] = useState(null);
  useEffect(() => {
    if (!userId) return;
    const unsub = onSnapshot(getGrapplerDoc(userId), (snap) => setProfile(snap.exists() ? snap.data() : null));
    return () => unsub();
  }, [userId]);

  const quickUpdate = async (patch) => {
    try {
      await setDoc(getGrapplerDoc(userId), { ...profile, ...patch, updatedAt: serverTimestamp() }, { merge: true });
    } catch (e) { console.error(e); }
  };

  return (
    <div className="rounded-xl p-5 bg-white shadow-lg">
      <h4 className="font-bold text-slate-900">Your Profile</h4>
      <p className="text-sm text-slate-600 mt-1">User ID: <span className="font-mono text-xs">{userId}</span></p>
      <div className="mt-4 space-y-2">
        {profile ? (
          <>
            <div className="grid grid-cols-2 gap-3 mt-2 text-sm">
              <ProfileField label="Name" value={profile.name} />
              <ProfileField label="Team" value={profile.team} />
              <ProfileField label="Belt" value={profile.belt} />
              <ProfileField label="Weight" value={`${profile.weight} kg`} />
              <ProfileField label="Location" value={`${profile.city}, ${profile.country}`} />
              <ProfileField label="Record" value={`W:${profile.wins || 0} / L:${profile.losses || 0}`} />
            </div>
            <div className="pt-3">
              <button onClick={() => quickUpdate({ looking: !profile?.looking })} className={`w-full px-3 py-3 rounded-lg text-sm font-bold transition-colors disabled:opacity-50 ${profile?.looking ? 'bg-yellow-400 text-black hover:bg-yellow-500' : 'bg-slate-200 text-slate-800 hover:bg-slate-300'}`}>
                {profile?.looking ? "Status: Looking for matches" : "Status: Not looking"}
              </button>
            </div>
          </>
        ) : <div className="text-sm text-slate-600 bg-slate-100 p-3 rounded-md">No profile yet. Fill out the form below to join the community.</div>}
      </div>
    </div>
  );
}

const ProfileField = ({label, value}) => (
    <div>
        <div className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</div>
        <div className="font-bold text-slate-800 truncate">{value || "‚Äî"}</div>
    </div>
);

const initialFormState = {
    name: "", instagram: "", zalo: "", belt: "White", weight: "", idealOpponent: "",
    team: "", city: "", country: "Vietnam", yearOfBirth: "", wins: "", losses: "",
    notableAchievements: "", facebook: "", photo: "", martialArtsOpportunity: "", worldImpact: "",
    whatsapp: "", telegram: "", email: "", bestContactMethod: "Email", notes: "",
    venue: "", eventType: "", assets: "", needs: "", localPartnerships: "",
    internationalPartnerships: "", desiredPartnerships: ""
};

function RegisterCard({ userId, showNotification, showModal }) {
  const [form, setForm] = useState(initialFormState);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [exists, setExists] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);

  useEffect(() => {
    if (!userId) return;
    getDoc(getGrapplerDoc(userId)).then((snap) => {
      if (snap.exists()) {
        setExists(true);
        setForm(prev => ({ ...initialFormState, ...snap.data() }));
      }
      setLoading(false);
    });
  }, [userId]);

  const handleGenerate = async () => {
    if (!form.belt || !form.weight) {
        showNotification("Please fill in belt and weight first.", "error");
        return;
    }
    setIsGenerating(true);
    try {
        const prompt = `Based on a BJJ practitioner who is a ${form.belt} belt and weighs ${form.weight}kg, write a short, exciting description for their 'ideal opponent' for a superfight. Be creative, one or two sentences.`;
        const generatedText = await callGeminiAPI({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        setForm(f => ({ ...f, idealOpponent: generatedText.replace(/["']/g, "") }));
    } catch (error) {
        showNotification("Could not generate description.", "error");
    }
    setIsGenerating(false);
  };

  const submit = async () => {
    if (!form.name || !form.weight) {
      showNotification("Please fill in your name and weight.", "error");
      return;
    }
    setSaving(true);
    try {
      await setDoc(getGrapplerDoc(userId), {
        ...form,
        uid: userId,
        weight: Number(form.weight) || 0,
        yearOfBirth: Number(form.yearOfBirth) || 0,
        wins: Number(form.wins) || 0,
        losses: Number(form.losses) || 0,
        createdAt: exists ? form.createdAt : serverTimestamp(),
        updatedAt: serverTimestamp(),
        deleted: false,
      }, { merge: true });
      setExists(true);
      showNotification(exists ? "Profile updated!" : "Profile saved!", "success");
    } catch (e) {
      showNotification("Error saving: " + e.message, "error");
    }
    setSaving(false);
  };

  const handleDelete = () => {
    showModal("Delete Profile?", "This will soft-delete your profile.", async () => {
      try {
        await updateDoc(getGrapplerDoc(userId), { deleted: true });
        showNotification("Removed from public list.", "success");
      } catch (e) {
        showNotification("Error removing profile: " + e.message, "error");
      }
    });
  };

  if (loading) return <div className="rounded-xl p-5 bg-white shadow-lg"><div className="text-sm text-slate-600">Loading profile‚Ä¶</div></div>;

  return (
    <div className="rounded-xl p-5 bg-white shadow-lg">
      <h4 className="font-bold text-xl text-slate-900">{exists ? "Edit Your Profile" : "Create Your Profile"}</h4>
      <div className="mt-4 space-y-6">
        <FormSection title="Basic Info">
            <InputField label="Name*" value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} placeholder="Your full name" />
            <InputField label="Photo URL" value={form.photo} onChange={e => setForm({ ...form, photo: e.target.value })} placeholder="https://..." />
            <InputField label="Team" value={form.team} onChange={e => setForm({ ...form, team: e.target.value })} placeholder="Your gym or affiliation" />
            <div className="grid grid-cols-2 gap-4">
                <InputField label="City" value={form.city} onChange={e => setForm({ ...form, city: e.target.value })} placeholder="e.g. Ho Chi Minh City" />
                <InputField label="Country" value={form.country} onChange={e => setForm({ ...form, country: e.target.value })} placeholder="e.g. Vietnam" />
            </div>
        </FormSection>

        <FormSection title="Contact Info">
            <InputField label="Email" type="email" value={form.email} onChange={e => setForm({ ...form, email: e.target.value })} placeholder="you@example.com" />
            <InputField label="WhatsApp" value={form.whatsapp} onChange={e => setForm({ ...form, whatsapp: e.target.value })} placeholder="+84..." />
            <InputField label="Telegram" value={form.telegram} onChange={e => setForm({ ...form, telegram: e.target.value })} placeholder="@username" />
            <div>
                <label className="block text-sm font-semibold text-slate-800 mb-1">Best way to contact</label>
                <select value={form.bestContactMethod} onChange={e => setForm({ ...form, bestContactMethod: e.target.value })} className="input-style">
                    {CONTACT_METHODS.map(m => <option value={m} key={m}>{m}</option>)}
                </select>
            </div>
        </FormSection>
        
        <FormSection title="Grappling Details">
            <div className="grid grid-cols-2 gap-4">
                <InputField label="Year of Birth" type="number" value={form.yearOfBirth} onChange={e => setForm({ ...form, yearOfBirth: e.target.value })} placeholder="e.g. 1990" />
                 <div>
                    <label className="block text-sm font-semibold text-slate-800 mb-1">Belt*</label>
                    <select value={form.belt} onChange={e => setForm({ ...form, belt: e.target.value })} className="input-style">
                        {BELTS.map(b => <option value={b} key={b}>{b}</option>)}
                    </select>
                </div>
                <InputField label="Weight (kg)*" type="number" value={form.weight} onChange={e => setForm({ ...form, weight: e.target.value })} placeholder="e.g. 78" />
                <div className="grid grid-cols-2 gap-2">
                   <InputField label="Wins" type="number" value={form.wins} onChange={e => setForm({ ...form, wins: e.target.value })} placeholder="0" />
                   <InputField label="Losses" type="number" value={form.losses} onChange={e => setForm({ ...form, losses: e.target.value })} placeholder="0" />
                </div>
            </div>
            <TextAreaField label="Notable Achievements" value={form.notableAchievements} onChange={e => setForm({ ...form, notableAchievements: e.target.value })} placeholder="Competition wins, personal milestones, etc." />
        </FormSection>

        <FormSection title="Socials">
             <InputField label="Facebook URL" value={form.facebook} onChange={e => setForm({ ...form, facebook: e.target.value })} placeholder="https://facebook.com/yourprofile" />
             <InputField label="Instagram" value={form.instagram} onChange={e => setForm({ ...form, instagram: e.target.value })} placeholder="@yourhandle" />
        </FormSection>

        <FormSection title="Community & Vision">
            <TextAreaField label="What opportunity do you want in martial arts this year?" value={form.martialArtsOpportunity} onChange={e => setForm({ ...form, martialArtsOpportunity: e.target.value })} placeholder="e.g., Compete internationally, teach a seminar, etc." />
            <TextAreaField label="How do you want to make an impact upon the world?" value={form.worldImpact} onChange={e => setForm({ ...form, worldImpact: e.target.value })} placeholder="Your personal mission..." />
        </FormSection>

        <FormSection title="Event Collaboration">
            <TextAreaField label="Do you have a unique venue where we could host a grappling event?" value={form.venue} onChange={e => setForm({ ...form, venue: e.target.value })} placeholder="Describe the venue, its location, capacity, etc." />
            <TextAreaField label="What type of events would you like to host or participate in?" value={form.eventType} onChange={e => setForm({ ...form, eventType: e.target.value })} placeholder="e.g., Seminars, superfights, open mats, charity events" />
            <TextAreaField label="What assets, capabilities, and resources do you have?" value={form.assets} onChange={e => setForm({ ...form, assets: e.target.value })} placeholder="e.g., Mat space, marketing skills, video equipment, volunteer team" />
            <TextAreaField label="What do you need to make an event happen?" value={form.needs} onChange={e => setForm({ ...form, needs: e.target.value })} placeholder="e.g., Sponsors, more participants, logistics help" />
        </FormSection>

        <FormSection title="Partnerships">
            <TextAreaField label="What are your most valuable partnerships in your country?" value={form.localPartnerships} onChange={e => setForm({ ...form, localPartnerships: e.target.value })} />
            <TextAreaField label="What are your most valuable international partnerships?" value={form.internationalPartnerships} onChange={e => setForm({ ...form, internationalPartnerships: e.target.value })} />
            <TextAreaField label="Who or what organizations would you like to partner with and why?" value={form.desiredPartnerships} onChange={e => setForm({ ...form, desiredPartnerships: e.target.value })} />
        </FormSection>
        
        <FormSection title="General">
             <TextAreaField label="Notes" value={form.notes} onChange={e => setForm({ ...form, notes: e.target.value })} placeholder="Anything else you'd like to share?" />
        </FormSection>

        <div className="pt-2">
          <button onClick={submit} disabled={saving} className="w-full px-4 py-3 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition-colors disabled:opacity-50 font-bold text-lg">
            {saving ? "Saving‚Ä¶" : exists ? "Update Profile" : "Create My Profile"}
          </button>
          {exists && <button onClick={handleDelete} className="w-full mt-3 px-4 py-2 rounded-lg bg-slate-200 hover:bg-red-200 text-red-800 transition-colors font-semibold">Remove Profile</button>}
        </div>
      </div>
    </div>
  );
}

const FormSection = ({ title, children }) => (
    <div className="border-t-2 border-red-600 pt-4">
        <h5 className="font-bold text-lg text-slate-800 mb-3">{title}</h5>
        <div className="space-y-4">{children}</div>
    </div>
);

const InputField = ({ label, ...props }) => (
    <label className="block">
        {label && <div className="text-sm font-semibold text-slate-800 mb-1">{label}</div>}
        <input {...props} className="input-style" />
    </label>
);

const TextAreaField = ({ label, ...props }) => (
    <label className="block">
        {label && <div className="text-sm font-semibold text-slate-800 mb-1">{label}</div>}
        <textarea {...props} rows="4" className="input-style" />
    </label>
);

function Dashboard({ currentUser, showNotification }) {
  const [grapplers, setGrapplers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [beltFilter, setBeltFilter] = useState("");
  const [minW, setMinW] = useState(40);
  const [maxW, setMaxW] = useState(120);
  
  const [isMatchmaking, setIsMatchmaking] = useState(false);
  const [matchmakingResult, setMatchmakingResult] = useState(null);
  const [selectedGrappler, setSelectedGrappler] = useState(null);

  useEffect(() => {
    const unsub = onSnapshot(query(getGrapplersCollection()), (snap) => {
      const arr = snap.docs.map(d => d.data()).filter(d => !d.deleted);
      arr.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
      setGrapplers(arr);
      setLoading(false);
    });
    return () => unsub();
  }, []);

  const handleFindMatch = async () => {
    setIsMatchmaking(true);
    setMatchmakingResult(null);
    
    const myProfile = grapplers.find(g => g.uid === currentUser.uid);
    if (!myProfile) {
        showNotification("Please create your profile first.", "error");
        setIsMatchmaking(false); return;
    }

    const opponents = grapplers.filter(g => g.uid !== currentUser.uid && g.looking);
    if (opponents.length === 0) {
        showNotification("No other grapplers are looking for matches.", "info");
        setIsMatchmaking(false); return;
    }
    
    try {
        const prompt = `You are a BJJ matchmaking expert. My profile is: ${JSON.stringify(myProfile)}. Here is a list of available opponents: ${JSON.stringify(opponents)}. Analyze the list and suggest the top 3 most interesting and competitive matchups for me based on weight, belt, record, and style (inferred from 'ideal opponent' and 'achievements'). For each suggestion, provide a brief, compelling reason (1-2 sentences). Return the result as a JSON array.`;
        const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { opponentName: { "type": "STRING" }, opponentUid: { "type": "STRING" }, reason: { "type": "STRING" } }, required: ["opponentName", "opponentUid", "reason"] } } }
        };
        const resultText = await callGeminiAPI(payload);
        setMatchmakingResult(JSON.parse(resultText));
    } catch (error) {
        showNotification("AI matchmaking failed. Please try again.", "error");
        setIsMatchmaking(false);
    }
  };

  const lookingGrapplers = grapplers.filter(g => g.looking);
  const filtered = lookingGrapplers.filter((g) => {
    if (beltFilter && g.belt !== beltFilter) return false;
    if (g.weight < minW || g.weight > maxW) return false;
    if (search) {
      const s = search.toLowerCase();
      return ['name', 'instagram', 'idealOpponent', 'team', 'city'].some(field => g[field]?.toLowerCase().includes(s));
    }
    return true;
  });

  return (
    <div>
      <div className="rounded-xl p-4 bg-white shadow-lg">
        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
          <div>
            <h3 className="font-bold text-slate-900">Community Members (Looking for matches)</h3>
            <p className="text-sm text-slate-600">{lookingGrapplers.length} total ‚Ä¢ {filtered.length} shown</p>
          </div>
          <button onClick={handleFindMatch} className="px-4 py-2 w-full sm:w-auto rounded-md bg-emerald-600 text-white hover:bg-emerald-700 transition-colors font-semibold">‚ú® Find My Match</button>
        </div>
        <div className="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 border-t pt-4">
          <input value={search} onChange={(e) => setSearch(e.target.value)} placeholder="Search name, team, city..." className="input-style md:col-span-1 lg:col-span-1" />
          <select value={beltFilter} onChange={(e) => setBeltFilter(e.target.value)} className="input-style"><option value="">All belts</option>{BELTS.map((b) => <option key={b} value={b}>{b}</option>)}</select>
          <div className="flex items-center gap-2">
            <label className="text-sm font-semibold text-slate-800">Weight:</label>
            <input type="number" value={minW} onChange={(e) => setMinW(Number(e.target.value))} className="input-style w-20" /><span className="text-slate-500">-</span>
            <input type="number" value={maxW} onChange={(e) => setMaxW(Number(e.target.value))} className="input-style w-20" /><span className="text-xs text-slate-600">kg</span>
          </div>
        </div>
      </div>
      {loading ? <div className="text-center p-10 text-slate-600">Loading members...</div> : <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-2 gap-4">{filtered.map((g) => <GrapplerCard key={g.uid} grappler={g} onClick={() => setSelectedGrappler(g)} />)}</div>}
      
      <MatchmakingModal isOpen={isMatchmaking} onClose={() => setIsMatchmaking(false)} results={matchmakingResult} grapplers={grapplers} />

      {selectedGrappler && <FullProfileModal isOpen={!!selectedGrappler} onClose={() => setSelectedGrappler(null)} grappler={selectedGrappler} currentUser={grapplers.find(g => g.uid === currentUser.uid)} showNotification={showNotification} />}
    </div>
  );
}

function GrapplerCard({ grappler, onClick }) {
  const age = grappler.yearOfBirth ? new Date().getFullYear() - grappler.yearOfBirth : null;

  return (
    <div onClick={onClick} className="rounded-xl p-4 bg-white shadow-lg transition-all hover:shadow-xl hover:scale-[1.02] cursor-pointer border-l-4 border-yellow-400">
      <div className="flex items-center gap-4">
        <img 
            src={grappler.photo || `https://placehold.co/100x100/e2e8f0/475569?text=${grappler.name ? grappler.name.charAt(0).toUpperCase() : 'G'}`} 
            alt={grappler.name} 
            className="w-20 h-20 rounded-full object-cover bg-slate-200 flex-shrink-0"
            onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/100x100/e2e8f0/475569?text=${grappler.name ? grappler.name.charAt(0).toUpperCase() : 'G'}`; }}
        />
        <div className="flex-1">
            <p className="font-bold text-lg text-slate-900">{grappler.name} {age && `(${age})`}</p>
            <p className="font-semibold text-slate-700">{grappler.team || 'Independent'}</p>
            <p className="text-sm text-slate-500">{grappler.belt} ‚Ä¢ {grappler.weight} kg ‚Ä¢ W:{grappler.wins || 0}/L:{grappler.losses || 0}</p>
        </div>
      </div>
    </div>
  );
}

function FAQPage() {
    const faqs = [
        {
            q: "What is SEA Grappling United?",
            a: "It's a community-driven platform designed to connect grapplers, promoters, and fans across Southeast Asia. Our goal is to pool resources, share ideas, and create more opportunities for everyone in the grappling community."
        },
        {
            q: "How do I use this platform?",
            a: "Create your profile with as much detail as possible. Use the dashboard to find other members, potential opponents, or collaborators for events. The more information you provide, the more the community can connect with you."
        },
        {
            q: "Is my data private?",
            a: "Your profile is public to other members of the platform to facilitate connections. We encourage you to only share information you are comfortable with being seen by the community. Your login information is secured by Firebase Authentication."
        },
        {
            q: "How does the AI matchmaking work?",
            a: "When you click 'Find My Match', we securely send your profile and the profiles of other members who are 'looking for matches' to the Gemini API. The AI analyzes this data to suggest interesting matchups based on skill level, weight, and style. No private data is stored by the AI."
        }
    ];

    return (
        <div className="rounded-xl p-6 bg-white shadow-lg">
            <h2 className="text-2xl font-bold text-black mb-6">Frequently Asked Questions</h2>
            <div className="space-y-6">
                {faqs.map((faq, index) => (
                    <div key={index} className="border-t-2 border-red-600 pt-4">
                        <h3 className="font-bold text-lg text-slate-900">{faq.q}</h3>
                        <p className="mt-1 text-slate-800">{faq.a}</p>
                    </div>
                ))}
            </div>
        </div>
    );
}

// --- Utility & Modal Components ---
function FullProfileModal({ isOpen, onClose, grappler, currentUser, showNotification }) {
    const [isGenerating, setIsGenerating] = useState(false);
    const [generatedContent, setGeneratedContent] = useState({ type: null, text: '' });

    if (!isOpen) return null;
    const isSelf = grappler.uid === currentUser?.uid;
    const age = grappler.yearOfBirth ? new Date().getFullYear() - grappler.yearOfBirth : null;

    const handleGenerateTrainingInsights = async () => {
        setIsGenerating(true);
        setGeneratedContent({ type: 'insights', text: '' });
        try {
            const prompt = `I am a ${grappler.belt} BJJ practitioner weighing ${grappler.weight}kg. This year, my goal in martial arts is: "${grappler.martialArtsOpportunity || 'to improve overall'}". Based on this, provide some actionable training insights. Include a suggestion for a specific drill, a strength & conditioning focus, and a conceptual focus for sparring. Format it as simple text, not markdown.`;
            const result = await callGeminiAPI({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
            setGeneratedContent({ type: 'insights', text: result });
        } catch (e) {
            showNotification("Could not generate insights.", "error");
        }
        setIsGenerating(false);
    };

    const handleGenerateCallout = async () => {
        setIsGenerating(true);
        setGeneratedContent({ type: 'callout', text: '' });
        try {
            const prompt = `I am ${currentUser.name}, a ${currentUser.belt} at ${currentUser.weight}kg. I want to challenge ${grappler.name}, a ${grappler.belt} at ${grappler.weight}kg, to a friendly but exciting BJJ superfight. Write a short, respectful, and cool-sounding call-out message (2-3 sentences) that I can post on social media. Mention both of our names.`;
            const result = await callGeminiAPI({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
            setGeneratedContent({ type: 'callout', text: result });
        } catch (e) {
            showNotification("Could not generate call-out.", "error");
        }
        setIsGenerating(false);
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
            <div className="bg-white rounded-lg shadow-xl w-full max-w-3xl relative max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="p-6 flex-shrink-0 border-b-2 border-slate-200">
                    <div className="flex items-start gap-6">
                        <img src={grappler.photo || `https://placehold.co/128x128/e2e8f0/475569?text=${grappler.name.charAt(0)}`} alt={grappler.name} className="w-24 h-24 md:w-32 md:h-32 rounded-full object-cover bg-slate-200 flex-shrink-0" onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/128x128/e2e8f0/475569?text=${grappler.name.charAt(0)}`; }}/>
                        <div className="flex-1">
                            <h3 className="text-3xl font-bold text-black">{grappler.name} {age && `(${age})`}</h3>
                            <p className="text-lg font-semibold text-slate-700">{grappler.team || 'Independent'}</p>
                            <p className="text-md text-slate-600">{grappler.city}, {grappler.country}</p>
                             <p className="text-md text-slate-600 mt-2">Best contact: <span className="font-bold text-slate-800">{grappler.bestContactMethod}</span></p>
                            <div className="mt-4 flex items-center gap-4">
                                {grappler.email && <SocialLink type="email" handle={grappler.email} />}
                                {grappler.facebook && <SocialLink type="facebook" handle={grappler.facebook} />}
                                {grappler.instagram && <SocialLink type="instagram" handle={grappler.instagram} />}
                                {grappler.whatsapp && <SocialLink type="whatsapp" handle={grappler.whatsapp} />}
                                {grappler.telegram && <SocialLink type="telegram" handle={grappler.telegram} />}
                            </div>
                        </div>
                    </div>
                </div>
                <div className="overflow-y-auto px-6 pb-6 space-y-5 pt-4">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center bg-slate-100 p-3 rounded-lg">
                        <ProfileDetail label="Belt" value={grappler.belt} />
                        <ProfileDetail label="Weight" value={`${grappler.weight} kg`} />
                        <ProfileDetail label="Wins" value={grappler.wins || 0} />
                        <ProfileDetail label="Losses" value={grappler.losses || 0} />
                    </div>
                    <ProfileSection title="Notable Achievements" content={grappler.notableAchievements} />
                    <ProfileSection title="Martial Arts Opportunity 2025" content={grappler.martialArtsOpportunity} />
                    <ProfileSection title="World Impact Goal" content={grappler.worldImpact} />
                    <ProfileSection title="Event Venue" content={grappler.venue} />
                    <ProfileSection title="Desired Event Types" content={grappler.eventType} />
                    <ProfileSection title="Available Assets & Resources" content={grappler.assets} />
                    <ProfileSection title="Needs for Events" content={grappler.needs} />
                    <ProfileSection title="Valuable Local Partnerships" content={grappler.localPartnerships} />
                    <ProfileSection title="Valuable International Partnerships" content={grappler.internationalPartnerships} />
                    <ProfileSection title="Desired Future Partnerships" content={grappler.desiredPartnerships} />
                    <ProfileSection title="Notes" content={grappler.notes} />

                    <div className="border-t pt-4">
                        {isSelf ? (
                            <button onClick={handleGenerateTrainingInsights} disabled={isGenerating} className="w-full px-4 py-2 rounded-md bg-emerald-600 text-white hover:bg-emerald-700 font-semibold disabled:opacity-50">
                                {isGenerating && generatedContent.type === 'insights' ? 'Generating...' : '‚ú® Generate Training Insights'}
                            </button>
                        ) : (
                            <button onClick={handleGenerateCallout} disabled={isGenerating} className="w-full px-4 py-2 rounded-md bg-sky-600 text-white hover:bg-sky-700 font-semibold disabled:opacity-50">
                                {isGenerating && generatedContent.type === 'callout' ? 'Generating...' : '‚ú® Generate Friendly Call-out'}
                            </button>
                        )}
                        {generatedContent.text && (
                            <div className="mt-4 p-4 bg-emerald-50 rounded-lg text-emerald-900 border border-emerald-200">
                                <p className="whitespace-pre-wrap font-medium">{generatedContent.text}</p>
                            </div>
                        )}
                    </div>
                </div>
                <button onClick={onClose} className="absolute top-4 right-4 text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
        </div>
    );
}

const ProfileDetail = ({ label, value }) => (
    <div>
        <div className="text-sm font-bold text-slate-600 uppercase tracking-wider">{label}</div>
        <div className="text-xl font-bold text-black">{value}</div>
    </div>
);

const ProfileSection = ({ title, content }) => {
    if (!content) return null;
    return (
        <div>
            <h5 className="font-bold text-md text-slate-900">{title}</h5>
            <p className="text-md text-slate-800 bg-slate-100 p-4 rounded-md mt-1 whitespace-pre-wrap">{content}</p>
        </div>
    );
};

function SocialLink({ type, handle }) {
    const urls = {
        instagram: handle.startsWith('http') ? handle : `https://instagram.com/${handle.replace(/^@/, "")}`,
        facebook: handle.startsWith('http') ? handle : `https://facebook.com/${handle}`,
        whatsapp: `https://wa.me/${handle.replace(/\D/g, "")}`,
        telegram: `https://t.me/${handle.replace(/^@/, "")}`,
        email: `mailto:${handle}`
    };
    const icons = {
        instagram: <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.584-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.011-3.584.069-4.85c.149-3.225 1.664-4.771 4.919-4.919C7.15 2.175 7.53 2.163 12 2.163m0-2.163C8.74.001 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.74 0 12s.014 3.667.072 4.947c.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072s3.667-.014 4.947-.072c4.358-.2 6.78-2.618 6.98-6.98.058-1.281.072-1.689.072-4.947s-.014-3.667-.072-4.947c-.2-4.358-2.618-6.78-6.98-6.98C15.667.014 15.26 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.88 1.44 1.44 0 000-2.88z" />,
        facebook: <path d="M22.675 0h-21.35C.59 0 0 .59 0 1.325v21.35C0 23.41.59 24 1.325 24H12.82v-9.29H9.692v-3.622h3.128V8.413c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12V24h6.116c.735 0 1.325-.59 1.325-1.325V1.325C24 .59 23.41 0 22.675 0z" />,
        whatsapp: <path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2 22l5.25-1.38c1.45.79 3.08 1.21 4.79 1.21h.01c5.46 0 9.91-4.45 9.91-9.91s-4.45-9.91-9.91-9.91zM12.04 20.15h-.01c-1.5 0-2.96-.4-4.24-1.14l-.3-.18-3.15.82.84-3.08-.2-.32a8.02 8.02 0 0 1-1.29-4.38c0-4.42 3.6-8.02 8.03-8.02s8.03 3.6 8.03 8.02-3.6 8.02-8.03 8.02zm4.52-6.13c-.25-.12-1.47-.72-1.7-.8s-.39-.12-.56.12c-.17.25-.64.8-.79.97s-.3.17-.56 0c-.25-.12-1.07-.4-2.04-1.26s-1.48-1.9-1.65-2.2c-.17-.3-.02-.46.1-.61.11-.13.25-.33.37-.49.12-.17.17-.29.25-.49s.04-.38-.02-.5c-.06-.12-.56-1.34-.76-1.84s-.4-.42-.55-.43h-.48c-.17 0-.45.06-.68.3s-.86.84-.86 2.04c0 1.2.88 2.36 1 2.53s1.75 2.67 4.24 3.73c.59.25 1.05.4 1.41.51.59.19 1.13.16 1.56.1.48-.07 1.47-.6 1.68-1.18.2-.58.2-1.08.14-1.18s-.25-.19-.5-.31z"/>,
        telegram: <path d="M11.95 0C5.35 0 0 5.35 0 11.95s5.35 11.95 11.95 11.95 11.95-5.35 11.95-11.95S18.55 0 11.95 0zm5.88 8.22-1.93 9.05c-.22.94-1.22 1.2-1.8.79l-4.4-3.24-2.13 2.05c-.24.24-.56.39-.9.39l.32-4.5 8.1-7.23c.35-.31-.08-.48-.54-.16l-10.05 6.2-4.33-1.35c-.93-.29-.93-1.4.18-1.71l15.1-5.58c.78-.29 1.48.24 1.2 1.15z"/>,
        email: <path d="M22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6zm-2 0-8 5-8-5h16zm0 12H4V8l8 5 8-5v10z"/>
    };
    return (
        <a href={urls[type] || '#'} target="_blank" rel="noreferrer" className="text-slate-500 hover:text-black transition-colors" title={type.charAt(0).toUpperCase() + type.slice(1)}>
            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">{icons[type]}</svg>
        </a>
    );
}

function MatchmakingModal({ isOpen, onClose, results, grapplers }) {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
            <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg relative">
                <h3 className="text-lg font-bold text-slate-900">‚ú® AI Matchmaking Results</h3>
                <div className="mt-4 max-h-[60vh] overflow-y-auto">
                    {!results ? (
                        <div className="flex flex-col items-center justify-center h-48"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"></div><p className="mt-4 text-slate-600">Analyzing matchups...</p></div>
                    ) : <div className="space-y-4">{results.length > 0 ? results.map((match, index) => {
                                const opponent = grapplers.find(g => g.uid === match.opponentUid);
                                if (!opponent) return null;
                                return (
                                    <div key={index} className="p-3 bg-slate-100 rounded-lg">
                                        <div className="flex items-start gap-3">
                                            <img src={opponent.photo || `https://placehold.co/100x100/e2e8f0/475569?text=${opponent.name.charAt(0)}`} alt={opponent.name} className="w-12 h-12 rounded-full object-cover bg-slate-200 flex-shrink-0" />
                                            <div className="flex-1">
                                                <p className="font-semibold text-slate-900">{opponent.name}</p>
                                                <p className="text-xs text-slate-600">{opponent.belt} ‚Ä¢ {opponent.weight} kg</p>
                                                <p className="mt-2 text-sm text-slate-800">{match.reason}</p>
                                            </div>
                                        </div>
                                    </div>
                                );
                            }) : <p className="text-slate-600">No suitable matches found.</p>}</div>}
                </div>
                <div className="mt-6 flex justify-end"><button onClick={onClose} className="px-4 py-2 rounded-md bg-slate-200 text-slate-800 hover:bg-slate-300 font-semibold">Close</button></div>
            </div>
        </div>
    );
}

function Modal({ isOpen, onClose, onConfirm, title, children }) {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
            <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 className="text-lg font-bold text-slate-900">{title}</h3>
                <div className="mt-2 text-sm text-slate-700">{children}</div>
                <div className="mt-6 flex justify-end gap-3">
                    <button onClick={onClose} className="px-4 py-2 rounded-md bg-slate-200 text-slate-800 hover:bg-slate-300 font-semibold">Cancel</button>
                    <button onClick={onConfirm} className="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 font-semibold">Confirm</button>
                </div>
            </div>
        </div>
    );
}

function Notification({ isVisible, message, type }) {
    if (!isVisible) return null;
    const bgColor = type === 'success' ? 'bg-emerald-600' : 'bg-red-600';
    return <div className={`fixed bottom-5 right-5 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`}>{message}</div>;
}

function Footer() {
    return (
        <footer className="mt-12 text-center text-sm text-slate-600 py-4">
            SEA Grappling United ‚Ä¢ For the Community, By the Community
        </footer>
    );
}

// --- Global Styles ---
const style = document.createElement('style');
style.textContent = `.input-style { @apply w-full rounded-lg border-2 border-slate-300 bg-white px-4 py-3 text-base text-slate-900 placeholder-slate-500 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition; }`;
document.head.append(style);
